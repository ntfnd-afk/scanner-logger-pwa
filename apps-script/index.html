<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Operator Dashboard</title>
  <style>
    :root{
      --bg:#0b0c0f; --card:#15171b; --border:#2a2d33; --text:#e6e9ee; --muted:#9aa3ad; --ok:#8fda8f; --ok-b:#2f5d2f; --bad:#ffaeae; --bad-b:#5d2f2f;
      --accent:#3b82f6;
    }
    [data-theme="light"]{
      --bg:#f5f7fb; --card:#ffffff; --border:#e5e9f0; --text:#0b0c0f; --muted:#56606b; --ok:#157d36; --ok-b:#cfead6; --bad:#b00020; --bad-b:#f7c7cf;
      --accent:#2563eb;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1.35fr 0.65fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .row{display:flex;align-items:center;gap:8px}
    .pill{padding:2px 6px;border-radius:999px;border:1px solid var(--border);white-space:nowrap;font-size:12px}
    .ok{color:var(--ok);border-color:var(--ok-b)}
    .bad{color:var(--bad);border-color:var(--bad-b)}
    .warn{color:#e0c86a;border-color:#5b5430}
    [data-theme="light"] .warn{color:#7a6400;border-color:#e9dfb3}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid var(--border);font-size:14px}
    th{text-align:left;color:var(--muted);user-select:none;cursor:default}
    #err{background:#3a1f1f;color:#ffd5d5;border:1px solid #5d2f2f;padding:8px;border-radius:8px;margin:12px 0;display:none;white-space:pre-wrap}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center}
    .toolbar input,.toolbar select{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 8px}
    .toolbar button{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 10px;cursor:pointer}
    .feed-error td{background-color: color-mix(in oklab, var(--bad) 15%, transparent)}
    .feed-bulk-remove td{background-color: color-mix(in oklab, var(--warn) 15%, transparent)}
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–æ–≥–æ–≤ —É–¥–∞–ª–µ–Ω–∏–π */
    .removal-single { background-color: color-mix(in oklab, var(--bad) 8%, transparent); }
    .removal-bulk { background-color: color-mix(in oklab, var(--warn) 8%, transparent); }
    .removal-details { font-size: 12px; color: var(--muted); }
    .removal-reason { font-style: italic; color: var(--text-dim); }
    .muted{opacity:.75}
    .scroll{max-height:420px;overflow:auto}
    .nowrap{white-space:nowrap}

    /* Tabs */
    .tabs{display:flex;gap:6px;margin:6px 0 12px}
    .tab{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer}
    .tab.active{border-color:var(--accent); box-shadow:0 0 0 1px var(--accent) inset}
    .tab + .spacer{flex:1}
    .hidden{display:none}

    /* Accordion for boxes/clients */
    .acc{border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden}
    .acc-h{background:var(--card);padding:8px 10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .acc-c{border-top:1px solid var(--border);padding:8px 10px;background:color-mix(in oklab, var(--card) 92%, #000 8%)}
    .badge{border:1px solid var(--border);border-radius:999px;padding:2px 6px;font-size:12px}

    /* Busy overlay */
    .busy{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;
          align-items:center;justify-content:center;z-index:9999}
    .busy.hidden{display:none}
    .busy .box{background:var(--card);border:1px solid var(--border);padding:14px 16px;
               border-radius:12px;display:flex;gap:10px;align-items:center;
               box-shadow:0 6px 24px rgba(0,0,0,.3)}
    .spinner{width:18px;height:18px;border:3px solid var(--border);
             border-top-color:var(--accent);border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ */
    .btn-remove {
      background: var(--bad);
      border: 1px solid var(--bad-b);
      color: white;
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    .btn-remove:hover {
      background: color-mix(in oklab, var(--bad) 80%, black);
      transform: scale(1.1);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è */
    .bulk-remove-section {
      margin-top: 12px;
      padding: 8px;
      background: color-mix(in oklab, var(--bad) 10%, var(--card));
      border: 1px solid color-mix(in oklab, var(--bad) 30%, var(--border));
      border-radius: 6px;
      text-align: center;
    }
    
    .btn-bulk-remove {
      background: var(--bad);
      border: 1px solid var(--bad-b);
      color: white;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .btn-bulk-remove:disabled {
      background: var(--muted);
      border-color: var(--border);
      color: var(--text-dim);
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .btn-bulk-remove:not(:disabled):hover {
      background: color-mix(in oklab, var(--bad) 80%, black);
      transform: translateY(-1px);
    }
    
    .item-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .selected-count {
      font-weight: 700;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div id="err"></div>

  <!-- FILTER BAR -->
  <div class="toolbar">
    <label>–î–∞—Ç–∞ <input id="fltDate" type="date"/></label>
    <label>–û–ø–µ—Ä–∞—Ç–æ—Ä
      <select id="fltOp"><option value="">(–≤—Å–µ)</option></select>
    </label>
    <label>–ö–ª–∏–µ–Ω—Ç
      <select id="fltClient"><option value="">(–≤—Å–µ)</option></select>
    </label>
    <span id="refreshPill" class="pill muted"><span id="refreshMsg">–æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ <b id="cd">‚Äî</b> —Å–µ–∫</span></span>
    <button id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <button id="btnTheme" title="–¢–µ–º–∞">üåô</button>
  </div>

  <!-- TABS -->
  <div class="tabs">
  <div class="tab active" data-tab="desk">–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª</div>
  <div class="tab" data-tab="boxes">–ö–æ—Ä–æ–±–∞</div>
  <div class="tab" data-tab="removals">–õ–æ–≥–∏ —É–¥–∞–ª–µ–Ω–∏–π</div>
  <div class="tab" data-tab="raw">–°—ã—Ä—ã–µ –ª–æ–≥–∏</div>
  <div class="tab" data-tab="export">–≠–∫—Å–ø–æ—Ä—Ç</div>
  <div class="spacer"></div>
  <button id="btnExportCsv" class="pill">CSV</button>
  <button id="btnExportGs" class="pill">–í Sheets</button>
  </div>


  <!-- TAB: DESK -->
  <section id="tab-desk">
    <div class="grid">
      <div class="card">
        <div class="row"><h3 style="margin:4px 0">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h3><span id="gen" class="pill"></span></div>
        <table id="ops"><thead>
          <tr>
            <th data-sort="operator">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th data-sort="online" class="nowrap">–°—Ç–∞—Ç—É—Å</th>
            <th data-sort="lastClient">–ö–ª–∏–µ–Ω—Ç</th>
            <th data-sort="lastCity">–ì–æ—Ä–æ–¥</th>
            <th data-sort="lastBox">–ö–æ—Ä–æ–±</th>
            <th data-sort="itemsToday">–°–∫–∞–Ω–æ–≤</th>
            <th data-sort="errorsToday">–û—à–∏–±–æ–∫</th>
            <th data-sort="lastSeenAt">–í—Ä–µ–º—è</th>
          </tr>
        </thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3 style="margin:4px 0">–°–≤–æ–¥–∫–∞ –¥–Ω—è</h3>
        <div id="sum" class="row" style="gap:12px"></div>
        <h4 style="margin:12px 0 6px">–ö–ª–∏–µ–Ω—Ç—ã</h4>
        <div class="scroll">
          <table id="clientsSum"><thead>
            <tr><th>–ö–ª–∏–µ–Ω—Ç</th><th>ITEM</th><th>–û—Ç–∫—Ä—ã—Ç–æ</th><th>–ó–∞–∫—Ä—ã—Ç–æ</th><th>–û—à–∏–±–æ–∫</th></tr>
          </thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin:4px 0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
      <div class="scroll">
        <table id="feed"><thead>
          <tr><th>–í—Ä–µ–º—è</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–¢–∏–ø</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–ì–æ—Ä–æ–¥</th><th>–ö–æ—Ä–æ–±</th><th>–®–ö</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- TAB: BOXES -->
  <section id="tab-boxes" class="hidden">
    <div id="boxesWrap"></div>
  </section>

  <!-- TAB: REMOVALS -->
  <section id="tab-removals" class="hidden">
    <div class="card">
      <div class="row" style="gap:16px; flex-wrap:wrap; margin:8px 0 12px">
        <label>–î–∞—Ç–∞ <input id="removalDate" type="date"/></label>
        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä
          <select id="removalOp"><option value="">(–≤—Å–µ)</option></select>
        </label>
        <label>–ö–ª–∏–µ–Ω—Ç
          <select id="removalClient"><option value="">(–≤—Å–µ)</option></select>
        </label>
        <button id="btnRemovalReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="scroll">
        <table id="removalTable"><thead>
          <tr><th>–í—Ä–µ–º—è</th><th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th><th>–¢–∏–ø</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–ö–æ—Ä–æ–±</th><th>–î–µ—Ç–∞–ª–∏</th><th>–ü—Ä–∏—á–∏–Ω–∞</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- TAB: RAW LOGS -->
  <section id="tab-raw" class="hidden">
    <div class="card">
      <div class="row" style="gap:16px; flex-wrap:wrap; margin:8px 0 12px">
        <label>–î–∞—Ç–∞ <input id="rawDate" type="date"/></label>
        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä
          <select id="rawOp"><option value="">(–≤—Å–µ)</option></select>
        </label>
        <button id="btnRawReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="scroll">
        <table id="rawTable"><thead>
          <tr><th>–í—Ä–µ–º—è</th><th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th><th>–¢–∏–ø</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–ì–æ—Ä–æ–¥</th><th>–ö–æ—Ä–æ–±</th><th>–®–ö</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>
  <section id="tab-export" class="hidden">
    <div class="card">
      <h3 style="margin:4px 0">–≠–∫—Å–ø–æ—Ä—Ç –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É</h3>
      <div class="row" style="gap:16px; flex-wrap:wrap; margin:8px 0 12px">
        <label>–° (–¥–∞—Ç–∞) <input id="expFrom" type="date"/></label>
        <label>–ü–æ (–¥–∞—Ç–∞) <input id="expTo" type="date"/></label>
        <label>–ö–ª–∏–µ–Ω—Ç
          <select id="expClient"><option value="">(–≤—Å–µ)</option></select>
        </label>
        <label>–ì–æ—Ä–æ–¥
          <select id="expCity"><option value="">(–≤—Å–µ)</option></select>
        </label>
        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä
          <select id="expOp"><option value="">(–≤—Å–µ)</option></select>
        </label>
        <button id="btnExportRangeSheet">–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Google –¢–∞–±–ª–∏—Ü—É</button>
        <button id="btnExportReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
      <p class="muted">–ü–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—ã/–æ–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤—ã–±–æ—Ä–∞.</p>
    </div>
  </section>
</div>

<!-- –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
<div id="busy" class="busy hidden">
  <div class="box">
    <div class="spinner"></div>
    <div id="busyMsg">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>
</div>

<script>
/* ---------- GLOBALS / THEME / UTILS ---------- */
let REFRESH_EVERY = 15;
let countdown = REFRESH_EVERY;
let lastState = null;
let currentSort = {table:'ops', field:'', dir: -1};
let activeTab = 'desk'; // desk | boxes | clients
const openState = { clients:new Set(), cities:new Set(), boxes:new Set() };

function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('dash_theme', t);
  document.getElementById('btnTheme').textContent = t==='light' ? 'üåû' : 'üåô';
}
function initTheme(){
  const saved = localStorage.getItem('dash_theme') || 'dark';
  applyTheme(saved);
  document.getElementById('btnTheme').addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    applyTheme(cur==='dark' ? 'light' : 'dark');
  });
}
function showErr(msg){ const el = document.getElementById('err'); el.textContent = msg; el.style.display = 'block'; }
function setCountdown(n){ countdown = n; document.getElementById('cd').textContent = String(countdown); }
function tick(){
  if (countdown<=0){
    silentRefresh = true;
    const pill = document.getElementById('refreshPill');
    const msg  = document.getElementById('refreshMsg');
    if (pill && msg){
      const ts = new Date().toLocaleTimeString();
      msg.textContent = `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${ts}`;
      pill.classList.remove('muted');
      pill.classList.add('ok');
      setTimeout(()=>{ msg.innerHTML = '–æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ <b id="cd">‚Äî</b> —Å–µ–∫'; pill.classList.add('muted'); pill.classList.remove('ok'); setCountdown(REFRESH_EVERY); }, 1500);
    }
    loadActiveTab();
  } else {
    setCountdown(countdown-1);
  }
}
function qs(id){ const el=document.getElementById(id); return el?el.value.trim():''; }
function suggestInterval(state){
  try{
    const first = state.feed && state.feed[0];
    if (!first) return 20;
    const [d,t] = first.ts.split(' ');
    const [dd,mm,yy] = d.split('.').map(Number);
    const [HH,MM,SS] = t.split(':').map(Number);
    const ms = new Date(yy, mm-1, dd, HH, MM, SS).getTime();
    const delta = Date.now() - ms;
    if (delta < 3*60*1000) return 8;
    if (delta < 10*60*1000) return 12;
    return 25;
  }catch(e){ return 20; }
}
function onlyBoxNumber(value){
  if (!value) return '‚Äî';
  const s = String(value);
  const i = s.indexOf('/');
  return i>-1 ? s.slice(i+1) : s;
}
  function hhmm(strDate){ if (!strDate) return '‚Äî'; const parts = strDate.split(' '); return parts[1] ? parts[1] : strDate; }

function onlineBadge(o){
  const ageSec = (typeof o.onlineAgeSec === 'number') ? o.onlineAgeSec : (Date.now() - (o.lastSeenMs || 0)) / 1000;
  let cls = 'ok', txt = 'üü¢ —Å–µ–π—á–∞—Å';
  if (ageSec >= 120 && ageSec <= 600){ cls = 'warn'; txt = 'üü° –Ω–µ–¥–∞–≤–Ω–æ'; }
  else if (ageSec > 600){ cls = 'bad'; txt = 'üî¥ –æ—Ñ—Ñ–ª–∞–π–Ω'; }
  const mins = Math.floor(ageSec/60);
  const hint = mins <= 0 ? '—Ç–æ–ª—å–∫–æ —á—Ç–æ' : `${mins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  return `<span class="pill ${cls}" title="${hint}">${txt}</span>`;
}

// Busy overlay helper
let silentRefresh = false; // –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö –≤–∫–ª–∞–¥–æ–∫
function setBusy(on, msg){
  const el = document.getElementById('busy');
  const m  = document.getElementById('busyMsg');
  if (msg) m.textContent = msg;
  if (silentRefresh && on) return; // –ø–æ–¥–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –∞–≤—Ç–æ-—Ä–µ—Ñ—Ä–µ—à–µ
  el.classList.toggle('hidden', !on);
}

/* ---------- DESK (–≥–ª–∞–≤–Ω–∞—è) ---------- */
function populateFiltersLists(data){
  const opSel = document.getElementById('fltOp');
  const clSel = document.getElementById('fltClient');
  const curOp = opSel.value, curCl = clSel.value;
  opSel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + (data.operatorsList||[]).map(o=>`<option value="${o}">${o}</option>`).join('');
  clSel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + (data.clientsList||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
  if ([...opSel.options].some(o=>o.value===curOp)) opSel.value = curOp;
  if ([...clSel.options].some(o=>o.value===curCl)) clSel.value = curCl;

  // –≠–∫—Å–ø–æ—Ä—Ç-–≤–∫–ª–∞–¥–∫–∞
  const expOp = document.getElementById('expOp');
  const expCl = document.getElementById('expClient');
  const expCi = document.getElementById('expCity');
  const expOpCur = expOp.value, expClCur = expCl.value;
  expOp.innerHTML = opSel.innerHTML;
  expCl.innerHTML = clSel.innerHTML;
  expCi.innerHTML = '<option value="">(–≤—Å–µ)</option>' + (data.citiesList||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
  if ([...expOp.options].some(o=>o.value===expOpCur)) expOp.value = expOpCur;
  if ([...expCl.options].some(o=>o.value===expClCur)) expCl.value = expClCur;
}


function renderDesk(data){
  if (typeof data === 'string') data = JSON.parse(data);
  lastState = data;

  populateFiltersLists(data);
  document.getElementById('gen').textContent = new Date(data.generatedAt).toLocaleTimeString();

  // Operators
  let ops = [...data.operators];
  if (currentSort.table==='ops' && currentSort.field){
    const f = currentSort.field, dir = currentSort.dir;
    ops.sort((a,b)=> (a[f]>b[f]?1:-1)*dir);
  }
  const tb = document.querySelector('#ops tbody'); tb.innerHTML='';
  ops.forEach(o=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${o.operator||'‚Äî'}</td>
      <td class="nowrap">${onlineBadge(o)}</td>
      <td>${o.lastClient||'‚Äî'}</td>
      <td>${o.lastCity||'‚Äî'}</td>
      <td>${onlyBoxNumber(o.lastBox)}</td>
      <td>${o.itemsToday}</td>
      <td>${o.errorsToday}</td>
      <td title="${o.lastSeenAt||''}">${hhmm(o.lastSeenAt)||'‚Äî'}</td>`;
    tb.appendChild(tr);
  });

  // Summary
  const sum = document.getElementById('sum');
  sum.innerHTML = [
    ['ITEM', data.summary.items],
    ['–û—Ç–∫—Ä—ã—Ç–æ', data.summary.opens],
    ['–ó–∞–∫—Ä—ã—Ç–æ', data.summary.closes],
    ['–û—à–∏–±–æ–∫', data.summary.errors],
  ].map(([k,v])=>`<span class="pill">${k}: <b>${v}</b></span>`).join(' ');

  // Clients summary table
  const cb = document.querySelector('#clientsSum tbody'); cb.innerHTML='';
  data.clients.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${c.client||'‚Äî'}</td><td>${c.items}</td><td>${c.boxesOpen}</td><td>${c.boxesClose}</td><td>${c.errors}</td>`;
    cb.appendChild(tr);
  });

  // Feed
  const fb = document.querySelector('#feed tbody'); fb.innerHTML='';
  data.feed.forEach(e=>{
    const tr=document.createElement('tr');
    if (e.type==='ERROR') tr.classList.add('feed-error');
    if (e.type==='BULK_REMOVE') tr.classList.add('feed-bulk-remove');
    tr.innerHTML = `<td title="${e.ts}">${hhmm(e.ts)}</td><td>${e.operator||'‚Äî'}</td><td>${e.type}</td><td>${e.client||'‚Äî'}</td><td>${e.city||'‚Äî'}</td><td>${onlyBoxNumber(e.box)}</td><td>${e.code||''}</td>`;
    fb.appendChild(tr);
  });

  REFRESH_EVERY = suggestInterval(data);
  setCountdown(REFRESH_EVERY);
  setBusy(false);
}

/* ---------- BOXES (accordion) ---------- */
function renderBoxes(data){
  if (typeof data === 'string') data = JSON.parse(data);
  const root = document.getElementById('boxesWrap');
  root.innerHTML = '';
  data.clients.forEach(c=>{
    const accClient = document.createElement('div'); accClient.className='acc';
    const hClient = document.createElement('div'); hClient.className='acc-h';
    hClient.innerHTML = `<div><b>${c.client}</b></div><div class="row"><span class="badge">–∫–æ—Ä–æ–±–æ–≤: ${c.totalBoxes}</span><span class="badge">—Å–∫–∞–Ω–æ–≤: ${c.totalItems}</span></div>`;
    const clientCtn = document.createElement('div'); clientCtn.className='acc-c hidden';
    if (openState.clients.has(c.client)) clientCtn.classList.remove('hidden');

    // –≥–æ—Ä–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞
    c.cities.forEach(city=>{
      const accCity = document.createElement('div'); accCity.className='acc';
      const hCity = document.createElement('div'); hCity.className='acc-h';
      hCity.innerHTML = `<div>–ì–æ—Ä–æ–¥: <b>${city.city}</b></div><div class="row"><span class="badge">–∫–æ—Ä–æ–±–æ–≤: ${city.totalBoxes}</span><span class="badge">—Å–∫–∞–Ω–æ–≤: ${city.totalItems}</span></div>`;
      const cityCtn = document.createElement('div'); cityCtn.className='acc-c hidden';
      const cityKey = c.client + '||' + city.city;
      if (openState.cities.has(cityKey)) cityCtn.classList.remove('hidden');

      // –∫–æ—Ä–æ–±–∫–∏ –≤ –≥–æ—Ä–æ–¥–µ
      city.boxes.forEach(b=>{
        const box = document.createElement('div'); box.className='acc';
        const bh = document.createElement('div'); bh.className='acc-h';
        bh.innerHTML = `<div>–ö–æ—Ä–æ–± ‚Ññ <b>${b.boxNo}</b></div><div class="row"><span class="badge">—Å–∫–∞–Ω–æ–≤: ${b.itemsCount}</span><span class="badge">${b.firstAt ? hhmm(b.firstAt) : ''} ‚Äî ${b.lastAt ? hhmm(b.lastAt) : ''}</span><span class="badge">${(b.operators||[]).join(', ')}</span></div>`;
        const bc = document.createElement('div'); bc.className='acc-c hidden';
        const boxKey = c.client + '||' + city.city + '||' + b.boxNo;
        if (openState.boxes.has(boxKey)) bc.classList.remove('hidden');

        if (b.items.length){
          const tbl = document.createElement('table');
          tbl.innerHTML = `<thead><tr><th><input type="checkbox" id="selectAll_${c.client}_${city.city}_${b.boxNo}" onchange="toggleAllItems('${c.client}_${city.city}_${b.boxNo}')"></th><th>–í—Ä–µ–º—è</th><th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th><th>–®–ö</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>`;
          const tb = document.createElement('tbody');
          b.items.forEach((it, index)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><input type="checkbox" class="item-checkbox" data-uuid="${it.uuid}" data-box="${c.client}/${b.boxNo}" data-code="${it.code}"></td>
              <td title="${it.ts}">${hhmm(it.ts)}</td>
              <td>${it.operator||'‚Äî'}</td>
              <td>${it.code||''}</td>
              <td>
                <button class="btn-remove" onclick="removeItem('${it.code}', '${b.client}/${b.boxNo}', '${it.operator}')" title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä">
                  üóëÔ∏è
                </button>
              </td>
            `;
            tb.appendChild(tr);
          });
          tbl.appendChild(tb);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
          const removeBtn = document.createElement('div');
          removeBtn.className = 'bulk-remove-section';
          removeBtn.innerHTML = `
            <button class="btn-bulk-remove" onclick="removeSelectedItems('${c.client}_${city.city}_${b.boxNo}')" disabled>
              –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (<span class="selected-count">0</span>)
            </button>
          `;
          
          bc.appendChild(tbl);
          bc.appendChild(removeBtn);
        } else {
          bc.textContent = '–ù–µ—Ç —Å–∫–∞–Ω–æ–≤';
        }

        bh.addEventListener('click', ()=>{ const opened = bc.classList.toggle('hidden')===false; if (opened) openState.boxes.add(boxKey); else openState.boxes.delete(boxKey); });
        box.appendChild(bh); box.appendChild(bc);
        cityCtn.appendChild(box);
      });

      hCity.addEventListener('click', ()=>{ const opened = cityCtn.classList.toggle('hidden')===false; if (opened) openState.cities.add(cityKey); else openState.cities.delete(cityKey); });
      accCity.appendChild(hCity); accCity.appendChild(cityCtn);
      clientCtn.appendChild(accCity);
    });

    hClient.addEventListener('click', ()=>{ const opened = clientCtn.classList.toggle('hidden')===false; if (opened) openState.clients.add(c.client); else openState.clients.delete(c.client); });
    accClient.appendChild(hClient); accClient.appendChild(clientCtn);
    root.appendChild(accClient);
  });
  setBusy(false);
}

/* ---------- CLIENTS (same grouping UI) ---------- */
function renderClients(data){
  if (typeof data === 'string') data = JSON.parse(data);
  const root = document.getElementById('clientsWrap');
  root.innerHTML = '';
  // —Ç–∞–∫–æ–π –∂–µ –≤—ã–≤–æ–¥, –ø–æ —Å—É—Ç–∏
  renderBoxes(data); // –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç
  // –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ç–∫—É –≤ clientsWrap
  document.getElementById('clientsWrap').innerHTML = document.getElementById('boxesWrap').innerHTML;
  setBusy(false);
}

/* ---------- LOADERS (desk/boxes/clients) ---------- */
function filtersObj(){
  return {
    date: document.getElementById('fltDate').value || '',
    operator: (document.getElementById('fltOp').value||'').trim(),
    client: (document.getElementById('fltClient').value||'').trim()
  };
}

function loadDesk(){
  const params = filtersObj();
  setBusy(!silentRefresh,'–û–±–Ω–æ–≤–ª—è–µ–º ¬´–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª¬ª‚Ä¶');
  if (window.google && google.script && google.script.run){
    google.script.run.withSuccessHandler(renderDesk).withFailureHandler(err=>{ setBusy(false); showErr('Server error: '+err); }).getDashboardState(params);
  } else {
    const url = new URL(window.location.href); url.search = '';
    url.searchParams.set('api','state');
    if (params.date) url.searchParams.set('date', params.date);
    if (params.operator) url.searchParams.set('operator', params.operator);
    if (params.client) url.searchParams.set('client', params.client);
    fetch(url, {cache:'no-store'}).then(r=>r.json()).then(renderDesk).catch(e=>{ setBusy(false); showErr(String(e)); });
  }
}

function loadBoxes(){
  const params = filtersObj();
  setBusy(!silentRefresh,'–ó–∞–≥—Ä—É–∂–∞–µ–º ¬´–ö–æ—Ä–æ–±–∞¬ª‚Ä¶');
  if (window.google && google.script && google.script.run){
    google.script.run.withSuccessHandler(renderBoxes).withFailureHandler(err=>{ setBusy(false); showErr('Server error: '+err); }).getBoxesState(params);
  } else {
    const url = new URL(window.location.href); url.search = '';
    url.searchParams.set('api','boxes');
    if (params.date) url.searchParams.set('date', params.date);
    if (params.operator) url.searchParams.set('operator', params.operator);
    if (params.client) url.searchParams.set('client', params.client);
    fetch(url, {cache:'no-store'}).then(r=>r.json()).then(renderBoxes).catch(e=>{ setBusy(false); showErr(String(e)); });
  }
}

function loadClients(){
  const params = filtersObj();
  setBusy(!silentRefresh,'–ó–∞–≥—Ä—É–∂–∞–µ–º ¬´–ö–ª–∏–µ–Ω—Ç—ã¬ª‚Ä¶');
  if (window.google && google.script && google.script.run){
    google.script.run.withSuccessHandler(renderClients).withFailureHandler(err=>{ setBusy(false); showErr('Server error: '+err); }).getClientsState(params);
  } else {
    const url = new URL(window.location.href); url.search = '';
    url.searchParams.set('api','clients');
    if (params.date) url.searchParams.set('date', params.date);
    if (params.operator) url.searchParams.set('operator', params.operator);
    if (params.client) url.searchParams.set('client', params.client);
    fetch(url, {cache:'no-store'}).then(r=>r.json()).then(renderClients).catch(e=>{ setBusy(false); showErr(String(e)); });
  }
}

function loadActiveTab(){
  if (activeTab === 'desk') { loadDesk(); }
  if (activeTab === 'boxes') { loadBoxes(); }
  if (activeTab === 'removals') { loadRemovals(); }
  // raw: –≥—Ä—É–∑–∏–º —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª
}

/* ---------- EXPORT ---------- */
function doExportCsv(){
  const params = filtersObj();
  const type = (activeTab === 'clients') ? 'clients' : 'boxes';
  setBusy(true,'–ì–æ—Ç–æ–≤–∏–º CSV‚Ä¶');
  if (window.google && google.script && google.script.run){
    google.script.run.withSuccessHandler(url => { setBusy(false); window.open(url, '_blank'); })
      .withFailureHandler(err => { setBusy(false); showErr('Export error: ' + err); })
      .buildExportUrl(params, type);
  } else {
    try{
      const url = new URL(window.location.href); url.search='';
      url.searchParams.set('api','export'); url.searchParams.set('type', type);
      if (params.date) url.searchParams.set('date', params.date);
      if (params.operator) url.searchParams.set('operator', params.operator);
      if (params.client) url.searchParams.set('client', params.client);
      window.open(url.toString(), '_blank');
    } finally { setBusy(false); }
  }
}
function doExportGs(){
  const params = filtersObj();
  const type = (activeTab === 'clients') ? 'clients' : 'boxes';
  setBusy(true,'–ì–æ—Ç–æ–≤–∏–º —Ñ–∞–π–ª –≤ Google Sheets‚Ä¶');
  if (window.google && google.script && google.script.run){
    google.script.run
      .withSuccessHandler(url => { setBusy(false); window.open(url, '_blank'); })
      .withFailureHandler(err => { setBusy(false); showErr('Export GS error: ' + err); })
      .exportToGoogleSheet(params, type);  // –∏–ª–∏ exportToGoogleSheetSimpleRPC
  } else {
    try{
      const url = new URL(window.location.href); url.search='';
      url.searchParams.set('api','export_gs'); url.searchParams.set('type', type);
      if (params.date) url.searchParams.set('date', params.date);
      if (params.operator) url.searchParams.set('operator', params.operator);
      if (params.client) url.searchParams.set('client', params.client);
      window.open(url.toString(), '_blank');
    } finally { setBusy(false); }
  }
}


document.getElementById('btnExportCsv').addEventListener('click', doExportCsv);
document.getElementById('btnExportGs').addEventListener('click', doExportGs);

function doExportRangeSheet(){
  silentRefresh = false;
  const f = document.getElementById('expFrom').value;
  const t = document.getElementById('expTo').value;
  const client = (document.getElementById('expClient').value||'').trim();
  const city   = (document.getElementById('expCity').value||'').trim();
  const operator = (document.getElementById('expOp').value||'').trim();
  if (!f || !t) { showErr('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã "–°" –∏ "–ü–æ"'); return; }

  const params = { dateFrom: f, dateTo: t, client, city, operator };
  setBusy(true,'–ì–æ—Ç–æ–≤–∏–º —ç–∫—Å–ø–æ—Ä—Ç –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É‚Ä¶');
  if (window.google && google.script && google.script.run){
    google.script.run
      .withSuccessHandler(url => { setBusy(false); window.open(url, '_blank'); })
      .withFailureHandler(err => { setBusy(false); showErr('Export range error: ' + err); })
      .exportRangeToGoogleSheetSimpleRPC(params);
  } else {
    try{
      const url = new URL(window.location.href); url.search='';
      url.searchParams.set('api','export_gs_range');
      Object.entries(params).forEach(([k,v])=> v && url.searchParams.set(k, v));
      window.open(url.toString(), '_blank');
    } finally { setBusy(false); }
  }
}
document.getElementById('btnExportRangeSheet').addEventListener('click', doExportRangeSheet);
  document.getElementById('btnExportReset').addEventListener('click', ()=>{
    // –°–±—Ä–æ—Å –∫ –¥–µ—Ñ–æ–ª—Ç—É: —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –¥–∞—Ç—ã, –ø—É—Å—Ç—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    const d = new Date(); const today = d.toISOString().slice(0,10);
    document.getElementById('expFrom').value = today;
    document.getElementById('expTo').value   = today;
    document.getElementById('expClient').value = '';
    document.getElementById('expCity').value   = '';
    document.getElementById('expOp').value     = '';
    refreshExportLists();
  });



/* ---------- SORT ---------- */
function initSort(){
  document.querySelectorAll('#ops thead th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const field = th.getAttribute('data-sort');
      if (currentSort.field === field){ currentSort.dir *= -1; }
      else { currentSort.field = field; currentSort.dir = -1; }
      if (lastState) renderDesk(lastState);
    });
  });
}

/* ---------- TABS ---------- */
function initTabs(){
  document.querySelectorAll('.tab').forEach(el=>{
    el.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      activeTab = el.getAttribute('data-tab');

      document.getElementById('tab-desk').classList.toggle('hidden', activeTab!=='desk');
      document.getElementById('tab-boxes').classList.toggle('hidden', activeTab!=='boxes');
      document.getElementById('tab-removals').classList.toggle('hidden', activeTab!=='removals');
      document.getElementById('tab-raw').classList.toggle('hidden', activeTab!=='raw');
      document.getElementById('tab-export').classList.toggle('hidden', activeTab!=='export');

      setCountdown(REFRESH_EVERY);
      loadActiveTab();
    });
  });
  const btn = document.getElementById('btnExport');
  if (btn) btn.addEventListener('click', doExport);
}

/* ---------- BOOT ---------- */
document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  initSort();
  initTabs();

  // –¥–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = —Å–µ–≥–æ–¥–Ω—è
  const d = new Date();
  document.getElementById('fltDate').value = d.toISOString().slice(0, 10);

  // –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç (—ç–∫—Å–ø–æ—Ä—Ç): —Å–µ–≥–æ–¥–Ω—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const today = d.toISOString().slice(0,10);
  document.getElementById('expFrom').value = today;
  document.getElementById('expTo').value = today;

  // —Ñ–∏–ª—å—Ç—Ä—ã
  document.getElementById('btnRefresh').addEventListener('click', () => {
    silentRefresh = false; setCountdown(REFRESH_EVERY); loadActiveTab();
  });
  document.getElementById('fltDate').addEventListener('change', () => {
    silentRefresh = false; setCountdown(REFRESH_EVERY); loadActiveTab();
  });
  document.getElementById('fltOp').addEventListener('change', () => {
    silentRefresh = false; setCountdown(REFRESH_EVERY); loadActiveTab();
  });
  document.getElementById('fltClient').addEventListener('change', () => {
    silentRefresh = false; setCountdown(REFRESH_EVERY); loadActiveTab();
  });

  loadActiveTab();
  setCountdown(REFRESH_EVERY);
  setInterval(tick, 1000);
  // –ö–∞—Å–∫–∞–¥–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç
  function refreshExportLists(){
    silentRefresh = false; setBusy(true,'–û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã‚Ä¶');
    const f = document.getElementById('expFrom').value;
    const t = document.getElementById('expTo').value;
    const clientSel = document.getElementById('expClient');
    const citySel   = document.getElementById('expCity');
    const opSel     = document.getElementById('expOp');
    const clientCur = clientSel.value; const cityCur = citySel.value; const opCur = opSel.value;
    const apply = (data)=>{
      // clients
      clientSel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + (data.clients||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
      if ([...clientSel.options].some(o=>o.value===clientCur)) clientSel.value = clientCur; else clientSel.value='';
      // cities
      const cc = data.citiesByClient[clientSel.value||''] || [];
      citySel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + cc.map(c=>`<option value="${c}">${c}</option>`).join('');
      if ([...citySel.options].some(o=>o.value===cityCur)) citySel.value = cityCur; else citySel.value='';
      // operators
      const key = (clientSel.value||'') + '||' + (citySel.value||'');
      const ops = data.operatorsByClientCity[key] || [];
      opSel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + ops.map(o=>`<option value="${o}">${o}</option>`).join('');
      if ([...opSel.options].some(o=>o.value===opCur)) opSel.value = opCur; else opSel.value='';
      setBusy(false);
    };
    if (window.google && google.script && google.script.run){
      google.script.run.withSuccessHandler(apply).withFailureHandler(()=>{ setBusy(false); }).getExportLists({dateFrom:f,dateTo:t});
    } else {
      const url = new URL(window.location.href); url.search='';
      url.searchParams.set('api','export_lists');
      url.searchParams.set('dateFrom',f); url.searchParams.set('dateTo',t);
      fetch(url).then(r=>r.json()).then(apply).catch(()=>{ setBusy(false); });
    }
  }
  document.getElementById('expFrom').addEventListener('change', refreshExportLists);
  document.getElementById('expTo').addEventListener('change', refreshExportLists);
  document.getElementById('expClient').addEventListener('change', refreshExportLists);
  document.getElementById('expCity').addEventListener('change', refreshExportLists);
  refreshExportLists();

  // RAW LOGS UI
  function loadRaw(){
    const dflt = document.getElementById('fltDate').value;
    const rd = document.getElementById('rawDate');
    if (!rd.value) rd.value = dflt; // –¥–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    setBusy(true,'–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—ã—Ä—ã–µ –ª–æ–≥–∏‚Ä¶');
    const d = rd.value || dflt;
    const op = (document.getElementById('rawOp').value||'').trim();
    const apply = (rows)=>{
      const tb=document.querySelector('#rawTable tbody'); tb.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td title="${r.ts}">${hhmm(r.ts)}</td><td>${r.operator||'‚Äî'}</td><td>${r.type}</td><td>${r.client||'‚Äî'}</td><td>${r.city||'‚Äî'}</td><td>${onlyBoxNumber(r.box)}</td><td>${r.code||''}</td>`;
        tb.appendChild(tr);
      });
      // –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
      const ops = Array.from(new Set(rows.map(r=> r.operator).filter(Boolean))).sort();
      const sel = document.getElementById('rawOp');
      const cur = sel.value;
      sel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + ops.map(o=>`<option value="${o}">${o}</option>`).join('');
      if ([...sel.options].some(o=>o.value===cur)) sel.value=cur;
      setBusy(false);
    };
    if (window.google && google.script && google.script.run){
      google.script.run.withSuccessHandler(apply).withFailureHandler(()=>{ setBusy(false); }).getRawLogs({date:d, operator:op});
    } else {
      const url = new URL(window.location.href); url.search='';
      url.searchParams.set('api','raw');
      url.searchParams.set('date', d);
      if (op) url.searchParams.set('operator', op);
      fetch(url).then(r=>r.json()).then(apply).catch(()=>{ setBusy(false); });
    }
  }
  document.getElementById('btnRawReload').addEventListener('click', ()=>{ silentRefresh=false; loadRaw(); });
  // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã
  function refreshRawOperators(){
    silentRefresh = false;
    setBusy(true,'–û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤‚Ä¶');
    const d = document.getElementById('rawDate').value || document.getElementById('fltDate').value;
    const sel = document.getElementById('rawOp');
    const cur = sel.value;
    const apply = (data)=>{
      const ops = (data.operators||[]);
      sel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + ops.map(o=>`<option value="${o}">${o}</option>`).join('');
      if ([...sel.options].some(o=>o.value===cur)) sel.value=cur;
      setBusy(false);
    };
    if (window.google && google.script && google.script.run){
      google.script.run.withSuccessHandler(apply).withFailureHandler(()=>{ setBusy(false); }).getRawOperators({date:d});
    } else {
      const url = new URL(window.location.href); url.search='';
      url.searchParams.set('api','raw_ops'); url.searchParams.set('date', d);
      fetch(url).then(r=>r.json()).then(apply).catch(()=>{ setBusy(false); });
    }
  }
  document.getElementById('rawDate').addEventListener('change', refreshRawOperators);
  // –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ –∑–∞–ø–æ–ª–Ω–∏–º —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
  refreshRawOperators();
  
  // –õ–û–ì–ò –£–î–ê–õ–ï–ù–ò–ô UI
  document.getElementById('btnRemovalReload').addEventListener('click', () => { 
    silentRefresh = false; 
    loadRemovals(); 
  });
});

/* ---------- –õ–û–ì–ò –£–î–ê–õ–ï–ù–ò–ô ---------- */
function loadRemovals() {
  const dflt = document.getElementById('fltDate').value;
  const rd = document.getElementById('removalDate');
  if (!rd.value) rd.value = dflt; // –¥–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  
  setBusy(true, '–ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏ —É–¥–∞–ª–µ–Ω–∏–π‚Ä¶');
  const d = rd.value || dflt;
  const op = (document.getElementById('removalOp').value || '').trim();
  const client = (document.getElementById('removalClient').value || '').trim();
  
  const apply = (data) => {
    const tb = document.querySelector('#removalTable tbody');
    tb.innerHTML = '';
    
    if (data.logs && data.logs.length > 0) {
      data.logs.forEach(log => {
        const tr = document.createElement('tr');
        const typeClass = log.type === 'BULK_REMOVE' ? 'removal-bulk' : 'removal-single';
        tr.classList.add(typeClass);
        
        tr.innerHTML = `
          <td title="${log.timestamp}">${hhmm(log.timestamp)}</td>
          <td>${log.operator}</td>
          <td>${log.type === 'BULK_REMOVE' ? '–ú–∞—Å—Å–æ–≤–æ–µ' : '–û–¥–∏–Ω–æ—á–Ω–æ–µ'}</td>
          <td>${log.client}</td>
          <td>${onlyBoxNumber(log.box)}</td>
          <td class="removal-details">${log.details}</td>
          <td class="removal-reason">${log.reason}</td>
        `;
        tb.appendChild(tr);
      });
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="7" style="text-align:center;color:var(--muted);padding:2rem;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ–± —É–¥–∞–ª–µ–Ω–∏—è—Ö</td>';
      tb.appendChild(tr);
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
    const operators = Array.from(new Set(data.logs?.map(l => l.operator).filter(Boolean) || [])).sort();
    const clients = Array.from(new Set(data.logs?.map(l => l.client).filter(Boolean) || [])).sort();
    
    const opSel = document.getElementById('removalOp');
    const clientSel = document.getElementById('removalClient');
    const opCur = opSel.value;
    const clientCur = clientSel.value;
    
    opSel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + operators.map(o => `<option value="${o}">${o}</option>`).join('');
    clientSel.innerHTML = '<option value="">(–≤—Å–µ)</option>' + clients.map(c => `<option value="${c}">${c}</option>`).join('');
    
    if ([...opSel.options].some(o => o.value === opCur)) opSel.value = opCur;
    if ([...clientSel.options].some(o => o.value === clientCur)) clientSel.value = clientCur;
    
    setBusy(false);
  };
  
  if (window.google && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(apply)
      .withFailureHandler(() => { setBusy(false); })
      .getRemovalLogs({ date: d, operator: op, client: client });
  } else {
    const url = new URL(window.location.href);
    url.search = '';
    url.searchParams.set('api', 'removal_logs');
    url.searchParams.set('date', d);
    if (op) url.searchParams.set('operator', op);
    if (client) url.searchParams.set('client', client);
    fetch(url).then(r => r.json()).then(apply).catch(() => { setBusy(false); });
  }
}

/* ---------- –£–î–ê–õ–ï–ù–ò–ï –¢–û–í–ê–†–û–í ---------- */
function removeItem(code, box, originalOperator) {
  const operator = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–æ–ø–µ—Ä–∞—Ç–æ—Ä):');
  if (!operator || operator.trim() === '') {
    alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞');
    return;
  }
  
  const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '–£–¥–∞–ª–µ–Ω–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ –¥–∞—à–±–æ—Ä–¥';
  
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä ${code} –∏–∑ –∫–æ—Ä–æ–±–∞ ${box}?\n\n–û–ø–µ—Ä–∞—Ç–æ—Ä: ${operator}\n–ü—Ä–∏—á–∏–Ω–∞: ${reason}`)) {
    return;
  }
  
  setBusy(true, '–£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä...');
  
  const params = new URLSearchParams({
    api: 'remove_item',
    operator: operator.trim(),
    box: box,
    code: code,
    reason: reason
  });
  
  const url = new URL(window.location.href);
  url.search = params.toString();
  
  fetch(url.toString(), { method: 'GET' })
    .then(response => response.json())
    .then(data => {
      setBusy(false);
      if (data.ok) {
        alert(`‚úÖ ${data.message}`);
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        loadActiveTab();
      } else {
        alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
      }
    })
    .catch(error => {
      setBusy(false);
      alert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
    });
}

/* ---------- –ú–ê–°–°–û–í–û–ï –£–î–ê–õ–ï–ù–ò–ï ---------- */
function toggleAllItems(boxKey) {
  const selectAll = document.getElementById(`selectAll_${boxKey}`);
  const checkboxes = document.querySelectorAll(`#selectAll_${boxKey}`).closest('table').querySelectorAll('.item-checkbox');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll.checked;
  });
  
  updateBulkRemoveButton(boxKey);
}

function updateBulkRemoveButton(boxKey) {
  const checkboxes = document.querySelectorAll(`#selectAll_${boxKey}`).closest('table').querySelectorAll('.item-checkbox:checked');
  const button = document.querySelector(`button[onclick="removeSelectedItems('${boxKey}')"]`);
  const countSpan = button.querySelector('.selected-count');
  
  const count = checkboxes.length;
  countSpan.textContent = count;
  button.disabled = count === 0;
}

function removeSelectedItems(boxKey) {
  const checkboxes = document.querySelectorAll(`#selectAll_${boxKey}`).closest('table').querySelectorAll('.item-checkbox:checked');
  
  if (checkboxes.length === 0) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
    return;
  }
  
  const operator = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–æ–ø–µ—Ä–∞—Ç–æ—Ä):');
  if (!operator || operator.trim() === '') {
    alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞');
    return;
  }
  
  const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –¥–∞—à–±–æ—Ä–¥';
  
  const selectedItems = Array.from(checkboxes).map(cb => ({
    uuid: cb.dataset.uuid,
    code: cb.dataset.code,
    box: cb.dataset.box
  }));
  
  const codesList = selectedItems.map(item => item.code).join(', ');
  
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedItems.length} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–æ—Ä–æ–±–∞?\n\n–¢–æ–≤–∞—Ä—ã: ${codesList}\n–û–ø–µ—Ä–∞—Ç–æ—Ä: ${operator}\n–ü—Ä–∏—á–∏–Ω–∞: ${reason}`)) {
    return;
  }
  
  setBusy(true, `–£–¥–∞–ª—è–µ–º ${selectedItems.length} —Ç–æ–≤–∞—Ä–æ–≤...`);
  
  const params = new URLSearchParams({
    api: 'bulk_remove_items',
    operator: operator.trim(),
    reason: reason,
    uuids: selectedItems.map(item => item.uuid).join(',')
  });
  
  const url = new URL(window.location.href);
  url.search = params.toString();
  
  fetch(url.toString(), { method: 'GET' })
    .then(response => response.json())
    .then(data => {
      setBusy(false);
      if (data.ok) {
        alert(`‚úÖ –£–¥–∞–ª–µ–Ω–æ ${data.removedCount} —Ç–æ–≤–∞—Ä–æ–≤`);
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        loadActiveTab();
      } else {
        alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
      }
    })
    .catch(error => {
      setBusy(false);
      alert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
    });
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('item-checkbox')) {
    const table = e.target.closest('table');
    const boxKey = table.querySelector('input[type="checkbox"]').id.replace('selectAll_', '');
    updateBulkRemoveButton(boxKey);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
    const selectAll = document.getElementById(`selectAll_${boxKey}`);
    const allCheckboxes = table.querySelectorAll('.item-checkbox');
    const checkedCheckboxes = table.querySelectorAll('.item-checkbox:checked');
    
    selectAll.checked = allCheckboxes.length === checkedCheckboxes.length;
    selectAll.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
  }
});

</script>
</body>
</html>
